# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Next.js Frontend CI

# Action Triggers
on:
  push:
    branches: 
      - "main"
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"
  pull_request:
    branches: 
      - "main"
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"
 

jobs:
  build:
    name: Frontend Test
    runs-on: ubuntu-latest

    steps:

    # Checkout Changes
    - name: Checkout
      uses: actions/checkout@v3
  
    # Start/Run the Database 
    - name: Start Database Container
      run: docker-compose -f "docker-compose.yml" up -d --build sql
  
    # Start/Run the Backend
    - name: Start Backend Container
      run: docker-compose -f "docker-compose.yml" up -d --build backend

    # Install Node
    - name: Install node
      uses: actions/setup-node@v1
      with:
        node-version: 18.x

     # Add Env Variables
    - name: Add .env.local
      working-directory: frontend
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: $${{ secrets.GOOGLE_CLIENT_SECRET }}
        BASE_URL: ${{ secrets.BASE_URL }}
        NEXT_AUTH_URL: ${{ secrets.NEXTAUTH }}
        NEXT_PUBLIC_NEXTAUTH_SECRET: ${{ secrets.NEXT_PUBLIC_NEXTAUTH_SECRET }}
      run: |
        touch .env.local
        echo $GOOGLE_CLIENT_ID > .env.local
        echo $GOOGLE_CLIENT_SECRET >> .env.local
        echo $BASE_URL >> .env.local
        echo $NEXT_AUTH_URL >> .env.local
        echo $NEXT_PUBLIC_NEXTAUTH_SECRET >> .env.local
  
    # Install Frontend Deps
    - name: Install dependencies
      working-directory: frontend
      run: npm install
  
    # Run Frontend Tests
    - name: Run tests
      working-directory: frontend
      run: npm run test
  
    # Stop the Database & Backend Containers
    - name: Stop containers
      run: docker-compose -f "docker-compose.yml" down
    